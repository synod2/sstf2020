sstf 2020 t_express

---

```
glibc 2.31 
CANARY    : ENABLED
FORTIFY   : disabled
NX        : ENABLED
PIE       : ENABLED
RELRO     : FULL
```

시작시 buy view use exit 메뉴 있음. 

buy시 티켓 타입에 따라 0x18 혹은 0x30 바이트 동적 할당됨. 

이름을 8바이트씩 입력받을 수 있음. 

티켓 인덱스 존재, 생성한 티켓들이 저장되고 view에서 인덱스별로 읽어올 수 있음. 

최대 인덱스는 6까지. 

use 메뉴에서는 할당된 티켓을 할당 해제할 수 있는데, 이것도 타입에 따라 할당 해제가 진행됨. 

use 시엔 티켓의 meal, safari, gift, ride 의 숫자를 변경할 수 있는데, 음수 이하로는 내려갈 수 없고, ride는 숫자가 올라간다. 

meal, safari, gift가 모두 0일 경우에는 해당 인덱스에 대해 free가 이뤄진다. 

free 시에는 인덱스 배열의 삭제나 초기화가 따로 이뤄지지는 않는듯.  따라서 더블프리가 가능하고, 힙 주소 leak도 가능하다. 

허나 2.31에서는 tcache 자체적으로 더블프리 체크를 하기때문에 곧바로 더블프리는 불가하다. 

2.29 라이브러리부터 추가된 체크 루틴으로, 2.31 에서도 동일하게 동작한다.  free된 청크에 key 멤버가 생겨서 티캐시 구조체의 포인터를 저장하는데, free시에 해당 값을 체크하여 티캐시 구조체의 포인터와 동일한지 체크한 후 에러를 발생시킨다. 이를 우회하려면 e->key를 덮어쓰거나 tcache를 6개 이상 사용하면 된다. 

그리고 , 먼저 할당한 티켓이 해제된 다음 새로 할당하면 2개 이상의 인덱스가 동일한 위치를 참조하게 만들 수 있다. 

일단 UAF 가 가능한지부터 확인을 해보자. 이 프로그램에서 할당 해제된 영역에 접근해 값을 변경시키려면 one-day 티켓 청크 할당 후, use에서 ride를 실행시켜 값을 증가하는 방법이 있다. 

그러나 원데이 티켓이 free되면 ride 값을 올리더라도 이후 구문에서 free가 한번 더 실행되어 더블프리 버그가 발생한다. 

사용할만한 프로그램상 취약점을 정리하면

1. free시에 인덱스 초기화 이뤄지지 않음.  이를 통해 heapbase 가져올 수 있다. 
2. free 한 다음 동일 크기 메모리 재 할당시 서로 다른 인덱스에서 같은 메모리를 참조함 
3. 인덱스 입력받을 때 음수 입력이 가능하다. 이를 이용해서 libc leak 이 가능하다.  인덱스를 저장할 때 문자열의 주소 위치를 저장하고, view에서 인덱스를 입력받아 출력할 때 전역변수 영역의 인덱스 배열보다 상위 위치에 있는 함수들의  plt를 참조 할 수 있다. 

1,3번에서 libc base와 heap base를 모두 가져올 수 있었으니 이제 overwrite 루틴만 찾아내면 된다. 

use에서는 view와 어셈구문이 달라 음수의 사용이 불가했다. 

이름을 입력받을 떄, 8바이트만큼 입력받는 경우 9바이트째에 00이 들어가는데, 힙 청크에서 이름 바로 다음에 ticket type을 명시하는 부분이 있다. 

이 값이 1일 경우는 one-ride, 0일 경우는 one-day 인데 , one-ride 힙 생성시에 8바이트를 꽉 채워서 입력시 해당 type 값이 0 이 되어 use 메뉴에서 one-day 처럼 사용이 가능하다. 

즉, key 값을 바꾸어 더블 프리가 가능하단 소리. 

더블프리가 되었다. 이제 원하는 주소를 입력하여 메모리를 할당하고, 동일영역 재할당으로 원하는 메모리 위치 주소를 원하는 값으로 바꿔볼 수 있다. 

이제 덮어씌워야 할 위치는? 당연히 hook이지.

이때, tcache 카운트로 인해 2번 연속 할당이 불가하므로, 하나의 힙을 미리 더 할당 해제 해둬야 한다. 

그러나, 제약조건 때문에 원샷가젯을 이용한 쉘 실행은 힘들어 보였다. 그럼 system("bin/sh")를 호출하는 수밖에. 

힙에 들어있는 값을 인자로 하여 free 함수를 호출하기 때문에, free_hook 주소값을 할당해준 다음에 "/bin/sh" 문자열을  힙 영역에 써주자. 

그리고 free_hook 자리에 system 함수의 주소를 넣어주자. 

대회 종료후에 풀이에 성공한게 아쉬울 따름...

SCTF{D1d_y0u_$ee_7he_7c4che_key}

















